import os, re
from pydub import AudioSegment
import openai
import sys
sys.stdout.reconfigure(encoding='utf-8')

openai.api_key = os.getenv("OPENAI_API_KEY")

os.makedirs("wav.file", exist_ok=True)
os.makedirs("mock_data/meetings", exist_ok=True)

SPEAKERS = {
    "철우": "alloy",    # 리더, 중저음
    "윤성": "verse",    # 기술 담당
    "정우": "nova",     # 데이터 담당
    "창용": "sage",     # 백엔드
    "용재": "onyx",     # QA 및 보안
    "소라": "ballad"    # 밝은 여성 (UI/디자인)
}


scripts = {
1: """철우: 네, 모두 안녕하세요. 2025년 10월 25일 회의를 시작하겠습니다. 오늘은 AI 업무자동화와 파일 기반 검색 추천 시스템의 전체 점검이 목적이에요. 지난주에 모델 정확도가 88%였는데, 이번 주 목표는 92% 이상으로 잡았습니다. 각 담당자별 진행 상황과 개선 계획을 공유해주세요.  

윤성: 네, 이번 주에 전처리 파이프라인을 전면적으로 리팩터링했습니다. 불필요한 특수문자 제거, 공백 처리, 형태소 오류 수정까지 완료했고, 새 정규화 모듈을 붙여봤어요. 토큰 수가 약 7% 줄어서 학습 속도가 빨라졌습니다. 다만 감정 분류 모델에서 중립 문장이 여전히 흔들려요. 그래서 이번 주 금요일까지 중립 문장 데이터셋을 재가공하고 추가 학습을 진행하겠습니다.  

정우: 데이터 쪽은 아직 밸런스 이슈가 있어요. 긍정 문장이 전체의 35%를 차지해서 편향이 생기더라고요. 이번엔 오버샘플링과 언더샘플링을 동시에 적용해서 분포를 균등하게 맞추는 중이에요. DVC로 버전 관리도 붙였습니다. 월요일 오전까지 새로운 학습 결과를 리포트로 정리해서 공유하겠습니다.  

창용: 백엔드는 Whisper Large에서 Faster-Whisper로 완전히 교체했습니다. 추론 속도가 평균 11초에서 6초대로 줄었고, GPU 메모리도 덜 먹어요. 대신 큐 처리 로직이 약간 꼬여서 멀티스레드 구조를 다시 정리 중이에요. 내일 저녁까지 수정 버전을 테스트 서버에 올리고, 일요일까지 성능 비교 리포트를 제출하겠습니다.  

소라: UI는 지난주에 카드형 레이아웃으로 완전히 바꿨고, 액션아이템을 바로 캘린더에 등록할 수 있는 기능도 넣었습니다. 디자인은 괜찮은데 다크모드에서 대비가 살짝 낮아요. 그래서 오늘 오후에 색상 대비를 10% 올려서 테스트할 예정이에요. 접근성 측면도 점검 중이라 금요일까지 QA 리포트를 완성하겠습니다.  

용재: 보안 파트에서는 회의록 내 인물명과 일정 정보가 로그에 남는 문제를 해결했습니다. AES-256 암호화를 적용했고, DB 접근 로그를 분리했어요. 다만 백업 서버 동기화가 불안정해서 다음 주 화요일까지 재검증할 예정입니다. 보안 테스트 결과는 화요일 오전까지 보고드리겠습니다.  

철우: 좋아요, 전반적으로 일정이 잘 맞춰지고 있네요. 윤성은 데이터 전처리 문서 금요일까지, 정우는 데이터 밸런스 리포트 월요일까지, 창용은 성능 리포트 일요일까지, 소라는 QA 리포트 금요일까지, 용재는 보안 검증 보고서 화요일까지로 정리합시다.  
이번 주 금요일 오전 10시에 중간 점검 회의를 진행하겠습니다. 그때까지 각자 담당 업무 마무리해주세요.
""",

2: """철우: 네, 모두 안녕하세요. 2025년 10월 26일 회의를 시작하겠습니다. 오늘은 데이터셋 품질 검증 결과랑 전처리 개선 진행 상황을 중심으로 이야기해보죠.  

윤성: 전처리 파이프라인은 어제 수정한 대로 정상 작동합니다. 특수문자 제거랑 공백 처리 문제도 해결됐고요. 다만 감정 분류 쪽에서 중립 문장 데이터가 조금 부족해서 이번 주 금요일까지 증강 작업을 한 번 더 진행하려고 합니다.  

정우: 전체 데이터 밸런스는 맞춰봤는데, 긍정 문장이 여전히 많아요. 40% 정도 비중이라서 약간 편향이 생깁니다. 오버샘플링과 언더샘플링을 병행하고, DVC로 버전 관리를 붙였어요. 내일까지 실험 로그를 푸시하고 결과 리포트를 올리겠습니다.  

창용: 백엔드는 Faster-Whisper 쪽 최적화를 조금 더 했습니다. 배치 사이즈를 8에서 12로 늘려서 처리 속도가 꽤 개선됐어요. 대신 GPU 메모리 사용률이 80%까지 올라가서 조정 중입니다. 오늘 안에 최적화된 버전을 테스트 서버에 올리겠습니다.  

소라: UI는 카드형 요약 디자인을 적용했고, 담당자별 색상도 넣었습니다. 지금은 접근성 테스트 중이에요. 오늘 오후까지 내부 피드백 반영하고 프로토타입을 배포할 예정이에요.  

용재: 보안 쪽은 Vault 스토리지 접근 속도를 개선 중이에요. 암호화 자체는 안정적으로 돌아가는데, 캐시 정책이 조금 불안정해서 내일까지 최적화할 예정입니다.  

철우: 좋아요, 전반적으로 일정이 잘 맞춰지고 있네요. 윤성은 데이터 증강 마무리 금요일까지, 정우는 로그 리포트 내일까지, 창용은 테스트 서버 업로드 오늘 중으로, 소라는 프로토타입 배포 오후까지, 용재는 캐시 최적화 내일까지 완료합시다. 내일 오전 10시에 다음 회의 진행할게요.

""",

3: """철우: 네, 10월 27일 회의를 시작하겠습니다. 오늘은 모델 학습 안정화와 하이퍼파라미터 조정 결과를 중심으로 점검하죠.  

윤성: 러닝레이트를 1e-4에서 5e-5로 낮췄더니 과적합이 줄었어요. validation loss도 0.12로 안정됐고요. 배치 크기를 32에서 24로 조정하니까 학습 속도도 좋아졌습니다. 오늘 저녁까지 그래프를 정리해서 공유드릴게요.  

정우: 전처리 스크립트는 수정 완료했습니다. 감정 레이블 오류가 있던 부분은 교차 검증했고, 이상치 데이터를 제외했습니다. 이번 주 안에 새 버전으로 푸시하겠습니다.  

창용: 서버에서 inference latency 튀는 구간이 있었는데, torch.compile 모드로 실행하니까 평균 응답이 4.6초까지 떨어졌습니다. 내일까지 결과 리포트 작성하겠습니다.  

소라: 카드형 UI는 피드백 반영해서 다크모드 대비를 10% 더 올렸어요. 사용자 반응이 괜찮습니다. 오늘 밤까지 색상 업데이트 마무리하겠습니다.  

용재: 로그 서버에서 일부 타임아웃이 있었어요. 리트라이 로직 추가하면 해결될 것 같아요. 오늘 안에 패치 적용하겠습니다.  

철우: 좋아요, 이번 주 흐름 좋습니다. 윤성은 그래프 정리 오늘 저녁까지, 정우는 전처리 스크립트 주 내로, 창용은 리포트 내일까지, 소라는 색상 업데이트 오늘 밤까지, 용재는 로그 패치 오늘 중으로 완료합시다. 내일은 성능 평가 중심으로 이야기합시다.

""",

4: """철우: 네, 모두 수고 많았습니다. 오늘은 10월 28일, 모델 성능 평가와 통합 테스트 결과를 공유하겠습니다.  

윤성: 새로운 데이터셋으로 학습한 결과, 정확도가 93.1%까지 올랐습니다. 감정 분류 안정성도 좋아졌어요. 다만 테스트 세트에 중복 문장이 일부 있어서 금요일까지 다시 정제하겠습니다.  

정우: 라벨 불일치 12건 수정했습니다. 인코딩 문제였어요. 오늘 중으로 수정본을 푸시하고 깃헙에 업로드하겠습니다.  

창용: 배포 자동화는 완성됐습니다. push 이벤트마다 Docker 컨테이너가 재시작돼요. 평균 배포 시간도 40초로 단축됐습니다. 내일까지 로그 시각화 기능을 추가하겠습니다.  

소라: UI 렌더링 속도가 조금 느렸는데, DOM 구조를 정리해서 개선 중이에요. 이번 금요일까지 최종 수정 버전 올리겠습니다.  

용재: SSL 인증서 자동 갱신 테스트 완료했습니다. cron 스케줄이 조금 불안정해서 내일까지 주기 재설정하고 결과 보고드리겠습니다.  

철우: 좋네요. 윤성은 데이터셋 정제 금요일까지, 정우는 라벨 수정 오늘 안에, 창용은 로그 시각화 내일까지, 소라는 UI 수정 금요일까지, 용재는 스케줄 재설정 내일까지 마무리해주세요. 내일은 요약 자동화 쪽 테스트 중심으로 회의 진행하겠습니다.

""",

5: """철우: 네, 안녕하세요. 오늘은 10월 29일 회의입니다. 회의 요약 자동화 기능과 액션아이템 추출 정확도를 중심으로 이야기하죠.  

윤성: Whisper Large-v3 모델로 테스트했을 때 인식률이 96%까지 나왔습니다. 잡음이 섞인 음성에서 오류가 있어서 이번 주 금요일까지 노이즈 필터링 추가하겠습니다.  

정우: STT 후처리 단계에서 띄어쓰기 오류가 여전히 조금 남습니다. mecab 사전에 신조어를 더 추가해서 내일까지 업데이트 버전 공유하겠습니다.  

창용: 자동 요약 결과를 DB에 저장하는 기능 붙였습니다. 간혹 JSON 파싱 에러가 있어서 로직 보완했습니다. 오늘 오후에 버그 픽스 배포하겠습니다.  

소라: 자동 요약 결과 화면은 표로 바꿨습니다. 담당자별 색상 구분 적용했고, 기한 지난 항목은 붉은색 표시됩니다. 오늘 안에 반응형 테스트 마무리하겠습니다.  

용재: 개인정보 필터링 모듈을 개선했습니다. 이름과 날짜 정보는 모두 암호화 저장되도록 바꿨습니다. 다음 주 화요일까지 키 관리 정책 정리하겠습니다.  

철우: 좋아요, 전반적으로 잘 진행되고 있네요. 윤성은 필터링 추가 금요일까지, 정우는 사전 업데이트 내일까지, 창용은 버그 픽스 오늘 오후까지, 소라는 테스트 오늘 중으로, 용재는 정책 정리 다음 주 화요일까지 마무리합시다. 내일은 최종 점검 회의로 갈게요.

""",
6: '''철우: 네, 모두 안녕하세요. 2025년 10월 30일 회의 시작하겠습니다. 오늘은 최종 점검과 발표 준비입니다.  

윤성: 모델 정확도는 93.8%, 추론 속도는 4.5초로 유지됩니다. 이번 주 내로 그래프 정리만 마무리하면 될 것 같습니다. 내일 오전까지 업로드하겠습니다.  

정우: 데이터셋은 클린 상태입니다. 중복 문장 제거했고 오류율은 0.2% 미만이에요. 오늘 오후까지 최종 리포트 올리겠습니다.  

창용: 서버 파이프라인은 정상이에요. 자동 배포도 잘 작동하고 있습니다. 로그 로테이션만 약간 밀려 있어서 내일까지 정리하겠습니다.  

소라: 발표용 대시보드 뷰를 완성했습니다. 클릭 한 번으로 회의록, 캘린더, 액션아이템으로 이동 가능해요. 오늘 밤까지 QA 체크리스트 마무리하겠습니다.  

용재: 보안 모듈은 테스트 완료됐습니다. DB 암호화와 SSL 인증 모두 통과했습니다. 금요일 오전까지 리포트 정리하겠습니다.  

철우: 좋아요, 전반적으로 일정이 잘 맞춰지고 있네요. 윤성은 그래프 내일 오전까지, 정우는 리포트 오늘 오후까지, 창용은 로그 내일까지, 소라는 QA 오늘 밤까지, 용재는 보안 리포트 금요일 오전까지 마무리합시다. 내일은 리허설 겸 최종 발표 리허설 진행할게요.'''
}

for idx, script in scripts.items():
    print(f"\n🎧 [{idx}] 회의 오디오 생성 중...")

    segments = []
    for i, line in enumerate(script.strip().split("\n")):
        match = re.match(r"(.+?): (.+)", line)
        if not match:
            continue

        speaker, text = match.groups()
        voice = SPEAKERS.get(speaker, "alloy")
        filename = f"temp_{idx}_{i:02d}_{speaker}.mp3"

        with openai.audio.speech.with_streaming_response.create(
            model="gpt-4o-mini-tts",
            voice=voice,
            input=text
        ) as response:
            response.stream_to_file(filename)

        print(f"  ✅ {speaker} → {filename}")
        seg = AudioSegment.from_file(filename, format="mp3") + AudioSegment.silent(duration=400)
        segments.append(seg)

    combined = sum(segments)
    final_path = f"wav.file/10월 2{idx+5}일 회의록.wav"
    combined.export(final_path, format="wav")
    print(f"🎉 {final_path} 생성 완료!")

print("\n✅ 모든 회의 오디오 생성 완료! (wav.file 폴더 확인)")
